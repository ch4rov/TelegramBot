services:
  # Telegram Bot API (Local Server для файлов >50MB)
  telegram-bot-api:
    image: aiogram/telegram-bot-api:latest
    container_name: ch4robo-api
    restart: unless-stopped
    environment:
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
    volumes:
      - telegram-api-data:/var/lib/telegram-bot-api
    ports:
      - "8081:8081"
    networks:
      - ch4robo-network

  # Cloudflared Tunnel (для OAuth callback через публичный URL)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: ch4robo-auth
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARED_TUNNEL_TOKEN}
    networks:
      - ch4robo-network
    depends_on:
      - telegrambot

  # Основной бот
  telegrambot:
    build:
      context: .
    container_name: ch4robo-bot
    restart: unless-stopped
    volumes:
      - ./data:/data
    environment:
      DB_TYPE: sqlite
      DB_PATH: /data/bot.db
      USE_LOCAL_SERVER: "True"
      LOCAL_SERVER_URL: "http://telegram-bot-api:8081"
      IS_TEST_ENV: "True"
      TEST_BOT_TOKEN: "${TEST_BOT_TOKEN}"
      BOT_TOKEN: "${BOT_TOKEN}"
      ADMIN_IDS: "${ADMIN_IDS}"
      TECH_CHAT_ID: "${TECH_CHAT_ID}"
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
      CLOUDFLARED_TUNNEL_TOKEN: "${CLOUDFLARED_TUNNEL_TOKEN}"
      TEST_PUBLIC_BASE_URL: "${TEST_PUBLIC_BASE_URL}"
      PUBLIC_BASE_URL: "${PUBLIC_BASE_URL}"
      LASTFM_API_KEY: "${LASTFM_API_KEY}"
      LASTFM_SECRET: "${LASTFM_SECRET}"
      TEST_SPOTIFY_CLIENT_ID: "${TEST_SPOTIFY_CLIENT_ID}"
      TEST_SPOTIFY_CLIENT_SECRET: "${TEST_SPOTIFY_CLIENT_SECRET}"
      SPOTIFY_CLIENT_ID: "${SPOTIFY_CLIENT_ID}"
      SPOTIFY_CLIENT_SECRET: "${SPOTIFY_CLIENT_SECRET}"
    ports:
      - "8088:8088"
      - "8089:8089"
    networks:
      - ch4robo-network
    depends_on:
      - telegram-bot-api

networks:
  ch4robo-network:
    name: ch4robo-network
    driver: bridge

volumes:
  telegram-api-data:
    name: ch4robo-api-data
