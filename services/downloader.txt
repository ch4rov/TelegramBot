import yt_dlp
import os
import shutil
import asyncio
import uuid
import logging

# Разрешенные домены
ALLOWED_DOMAINS = ["tiktok.com", "instagram.com", "twitch.tv", "youtube.com", "youtu.be", "soundcloud.com"]

def is_valid_url(url: str) -> bool:
    return any(domain in url for domain in ALLOWED_DOMAINS)

async def download_content(url: str):
    """
    Скачивает контент и возвращает:
    1. Список путей к файлам (list)
    2. Путь к папке (str) - чтобы потом её удалить
    3. Текст ошибки (str) или None
    """
    # 1. Проверка домена
    if not is_valid_url(url):
        return None, None, "Ссылка не поддерживается или домен запрещен ⛔"

    # Генерируем уникальную папку для этого скачивания
    unique_id = str(uuid.uuid4())
    download_folder = os.path.join("downloads", unique_id)
    
    if not os.path.exists(download_folder):
        os.makedirs(download_folder)

    ydl_opts = {
        # Сохраняем файлы внутрь уникальной папки
        'outtmpl': f'{download_folder}/%(title)s.%(ext)s',
        'format': 'bestvideo+bestaudio/best', 
        'noplaylist': True,
        'max_filesize': 50 * 1024 * 1024, # 50 MB
        'http_headers': {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        },
        'ignoreerrors': True, # Чтобы не падать, если 1 файл из альбома битый
        'quiet': True,
    }

    try:
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(None, lambda: _run_yt_dlp(url, ydl_opts))

        # Собираем все скачанные файлы
        files = []
        for root, dirs, filenames in os.walk(download_folder):
            for filename in filenames:
                file_path = os.path.join(root, filename)
                files.append(file_path)

        if not files:
            shutil.rmtree(download_folder, ignore_errors=True)
            return None, None, "Не удалось найти медиафайлы или ошибка доступа."

        return files, download_folder, None

    except Exception as e:
        shutil.rmtree(download_folder, ignore_errors=True)
        return None, None, f"Ошибка при загрузке: {str(e)}"

def _run_yt_dlp(url, opts):
    with yt_dlp.YoutubeDL(opts) as ydl:
        ydl.download([url])